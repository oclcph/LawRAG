name: RAG CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # lint-test:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v4
    
  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.12'

  #   - name: Install dependencies
  #     run: |
  #       pip install -r requirements.txt
  
  build-transfer:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Docker Image
      run: |
        docker build -t rag-app:latest .

    - name: Save Docker Image as .tar
      run: |
        docker save -o rag-app.tar rag-app:latest

    - name: Transfer Image to Server via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        source: "rag-app.tar"
        target: "/root"

  deploy:
    needs: build-transfer
    runs-on: ubuntu-latest
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        command_timeout: 600
        script: |
          # 进入服务器后，加载 Docker 镜像
          docker load -i /home/${{ secrets.SERVER_USER }}/rag-app.tar

          # 停止并删除旧容器（如果存在）
          docker stop rag-app || true
          docker rm rag-app || true

          # 运行新容器
          docker run -d \
            --name rag-app \
            -p 8000:8000 \
            -v /law_db:/app/data \
            rag-app:latest